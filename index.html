<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analisis Gambar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Animasi Loading */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Scrollbar for results */
        .prose::-webkit-scrollbar {
            width: 8px;
        }
        .prose::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .prose::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .prose::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100 text-slate-800">

    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[600px]">
        
        <!-- Kolom Kiri: Input & Upload -->
        <div class="w-full md:w-1/2 p-6 md:p-8 flex flex-col border-r border-slate-100">
            <header class="mb-6">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                        <i data-lucide="scan-eye"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800">AI Vision</h1>
                </div>
                <p class="text-slate-500 text-sm">Unggah gambar untuk dianalisis oleh Ai</p>
            </header>

            <!-- Upload Area -->
            <div id="drop-zone" class="flex-1 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 flex flex-col items-center justify-center p-6 transition-all hover:border-blue-400 hover:bg-blue-50 cursor-pointer relative group">
                <input type="file" id="file-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                
                <div id="upload-placeholder" class="text-center">
                    <div class="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 text-blue-500 group-hover:scale-110 transition-transform">
                        <i data-lucide="upload-cloud" size="32"></i>
                    </div>
                    <p class="text-slate-700 font-medium">Klik atau Tarik Gambar ke Sini</p>
                    <p class="text-xs text-slate-400 mt-2">JPG, PNG, WEBP (Maks 5MB)</p>
                </div>

                <div id="image-preview-container" class="hidden w-full h-full relative flex flex-col items-center justify-center">
                    <img id="image-preview" src="" alt="Preview" class="max-h-[300px] w-auto object-contain rounded-lg shadow-sm">
                    <button id="remove-image" class="absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 shadow-sm hover:bg-red-50 z-20">
                        <i data-lucide="x" size="16"></i>
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="mt-6 space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Instruksi / Pertanyaan</label>
                    <textarea id="prompt-input" rows="2" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm resize-none" placeholder="Contoh: Jelaskan gambar ini secara detail..."></textarea>
                </div>

                <button id="analyze-btn" disabled class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg font-medium shadow-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <i data-lucide="sparkles" size="18"></i>
                    <span>Analisis Gambar</span>
                </button>
            </div>
        </div>

        <!-- Kolom Kanan: Hasil -->
        <div class="w-full md:w-1/2 bg-slate-50 p-6 md:p-8 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                    <i data-lucide="file-text" size="18" class="text-slate-400"></i>
                    Hasil Analisis
                </h2>
                <div id="status-badge" class="hidden px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full flex items-center gap-1">
                    <div class="loader mr-1" style="width: 12px; height: 12px; border-width: 2px;"></div>
                    Memproses...
                </div>
            </div>

            <div id="result-container" class="flex-1 bg-white rounded-xl border border-slate-200 p-4 overflow-y-auto prose prose-sm max-w-none text-slate-600 shadow-sm relative min-h-[200px]">
                
                <!-- State: Kosong -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 text-slate-400">
                    <i data-lucide="microscope" size="48" class="mb-3 opacity-20"></i>
                    <p class="text-sm">Hasil analisis AI akan muncul di sini.</p>
                </div>

                <!-- State: Konten -->
                <div id="analysis-content" class="hidden text-sm leading-relaxed"></div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-4 p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-start gap-2">
                <i data-lucide="alert-circle" size="16" class="mt-0.5 shrink-0"></i>
                <span id="error-text">Terjadi kesalahan.</span>
            </div>
        </div>
    </div>

    <footer class="mt-8 text-slate-500 text-xs text-center">
        <p>Github : Dhammmmm</p>
    </footer>

    <script>
        // API Key injection (dikelola oleh environment)
        const apiKey = "AIzaSyC9-jAzwHDuqbgosOZcn7N_u-40kZkKcdw"; 

        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const removeImageBtn = document.getElementById('remove-image');
        const analyzeBtn = document.getElementById('analyze-btn');
        const promptInput = document.getElementById('prompt-input');
        const resultContainer = document.getElementById('result-container');
        const emptyState = document.getElementById('empty-state');
        const analysisContent = document.getElementById('analysis-content');
        const statusBadge = document.getElementById('status-badge');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        let currentBase64 = null;
        let currentMimeType = null;

        // Initialize Icons
        lucide.createIcons();

        // --- Event Listeners ---

        // Drag & Drop effects
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-400', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // File Input Change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        // Remove Image
        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent triggering file input
            resetUI();
        });

        // Analyze Button Click
        analyzeBtn.addEventListener('click', performAnalysis);

        // --- Functions ---

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError("Mohon unggah file gambar (JPG, PNG, WEBP).");
                return;
            }

            // Batas ukuran sederhana (Client side check)
            if (file.size > 5 * 1024 * 1024) {
                showError("Ukuran gambar terlalu besar. Maksimal 5MB.");
                return;
            }

            hideError();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const base64String = e.target.result;
                currentBase64 = base64String.split(',')[1]; // Remove data:image/...;base64, prefix
                currentMimeType = file.type;

                // Show Preview
                imagePreview.src = base64String;
                uploadPlaceholder.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
                analyzeBtn.disabled = false;
                
                // Reset result area if it's a new image
                analysisContent.innerHTML = '';
                analysisContent.classList.add('hidden');
                emptyState.classList.remove('hidden');
            };

            reader.readAsDataURL(file);
        }

        function resetUI() {
            fileInput.value = '';
            currentBase64 = null;
            currentMimeType = null;
            
            imagePreview.src = '';
            uploadPlaceholder.classList.remove('hidden');
            imagePreviewContainer.classList.add('hidden');
            analyzeBtn.disabled = true;
            
            analysisContent.innerHTML = '';
            analysisContent.classList.add('hidden');
            emptyState.classList.remove('hidden');
            hideError();
        }

        function showError(msg) {
            errorMessage.classList.remove('hidden');
            errorText.textContent = msg;
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        async function performAnalysis() {
            if (!currentBase64) return;

            const userPrompt = promptInput.value.trim() || "Jelaskan gambar ini secara detail dan tunjukkan hal-hal menarik di dalamnya. Gunakan Bahasa Indonesia.";

            // UI Loading State
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<div class="loader border-white border-t-transparent mr-2"></div> Menganalisis...`;
            statusBadge.classList.remove('hidden');
            emptyState.classList.add('hidden');
            analysisContent.classList.remove('hidden');
            analysisContent.innerHTML = '<p class="text-slate-400 italic">Sedang membaca gambar...</p>';
            hideError();

            try {
                // API Call Logic with Exponential Backoff
                const result = await generateContentWithRetry(userPrompt, currentBase64, currentMimeType);
                
                // Parse and Display Result
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    // Use marked library to parse markdown to HTML
                    analysisContent.innerHTML = marked.parse(text);
                    analysisContent.classList.add('fade-in');
                } else {
                    throw new Error("Tidak ada respon dari AI.");
                }

            } catch (error) {
                console.error("Analysis Error:", error);
                showError("Gagal menganalisis gambar. Silakan coba lagi. " + error.message);
                analysisContent.innerHTML = '';
                emptyState.classList.remove('hidden');
            } finally {
                // Restore UI State
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = `<i data-lucide="sparkles" size="18" class="mr-2"></i> Analisis Gambar`;
                lucide.createIcons(); // Re-init icons for the button
                statusBadge.classList.add('hidden');
            }
        }

        // Helper: Exponential Backoff for API
        async function generateContentWithRetry(prompt, base64Data, mimeType, retries = 3) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }]
            };

            let delay = 1000;

            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `HTTP Error ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    if (i === retries) throw error;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }
    </script>
</body>
</html>

